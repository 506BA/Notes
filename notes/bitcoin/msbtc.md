# Mastering Bitcoin

## Chapter 1
比特币由这些构成：

-   一个去中心化的点对点网络（比特币协议）
-   一个公共的交易账簿（区块链）
-   一个去中心化的数学的和确定性的货币发行（分布式挖矿）
-   一个去中心化的交易验证系统（交易脚本）

**全节点客户端**

完整客户端或“全节点”是存储比特币交易的全部历史（每个用户每次交易）的客户端，管理用户的钱包，并且可以直接在比特币网络上启动交易。全节点处理协议的所有方面，并可以独立地验证整个区块链和任何交易。全节点客户端消耗大量计算机资源（例如，超过250 GB的磁盘，2 GB的RAM），但可以提供完全自主和独立的交易验证。


Alice <--> Joe 
Alice不愿意太冒险，只决定将10美元转换成比特币。她给Joe 10美元现金

Joe然后在他的智能手机钱包上选择发送，并显示一个包含两个输入的屏幕：

- 收款方的比特币地址
- 以比特币（BTC）或其当地法币（USD）计价的发送金额

***确认交易***

起初，Alice的钱包把与Joe的这笔交易显示为“**未确认**”。这意味着交易已传播到网络，但尚未记录在比特币交易账簿即区块链中。确认，就是一个交易必须包含在一个区块中，并被添加到区块链，这样的情况平均每10分钟发生一次。

-----

## Chapter 2

比特币系统由用户、交易和矿工组成，其中用户主要使用密钥控制钱包，交易会被广播到整个比特币网络，矿工通过算力竞争生产出具备所有节点共识的区块链，区块链是一个分布式的公开权威账簿， 包含了比特币网络发生的所有的交易。

Alice -> Bob
交易信息：
```json
{
  "txid": "0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2",
  "size": 258,
  "version": 1,
  "locktime": 0,
  "fee": 50000,
  "inputs": [
    {
      "coinbase": false,
      "txid": "7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18",
      "output": 0,
      "sigscript": "483045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e381301410484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf",
      "sequence": 4294967295,
      "pkscript": "76a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac",
      "value": 10000000,
      "address": "1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK",
      "witness": []
    }
  ],
  "outputs": [
    {
      "address": "1GdK9UzpHBzqzX2A9JFP3Di4weBwqgmoQA",
      "pkscript": "76a914ab68025513c3dbd2f7b92a94e0581f5d50f654e788ac",
      "value": 1500000,
      "spent": false,
      "spender": null
    },
    {
      "address": "1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK",
      "pkscript": "76a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac",
      "value": 8450000,
      "spent": false,
      "spender": null
    }
  ],
  "block": {
    "height": 277316,
    "position": 64
  },
  "deleted": false,
  "time": 1388185914,
  "rbf": false,
  "weight": 1032
}
```

Alice支付Bob咖啡时使用一笔之前的交易作为输入。在以前的章节中，Alice从她朋友Joe那里用现金换了点比特币。那笔交易创建了被Alice的密钥锁定的比特币。在她支付Bob咖啡店的新交易中使用了之前的交易作为输入，输出是支付咖啡的金额和多余部分的找零。交易形成了一条链，最近交易的输入对应以前交易的输出。Alice用密钥签名解锁了之前交易的输出，从而向比特币网络证明她拥有这笔钱。她将买咖啡的这笔支付到Bob的地址上，明确指明要求是Bob签名才能消费这笔钱，否则就“阻止”那笔输出。这就实现了在Alice和Bob之间价值转移。*UTXO*

Alice的钱包应用首先会找到一些足够支付给Bob所需金额的输入。大多数钱包应用都会跟踪着的属于钱包的地址的所有可用输出。因此Alice的钱包会包含她用现金从Joe那里购买的比特币的交易输出副本。全节点客户端含有整个区块链中所有交易的所有未消费输出副本。这使得钱包既能拿这些输出构建交易，又能在收到新交易时很快地验证其输入是否正确。但是，全节点客户端占太大的硬盘空间，所以大多数钱包使用轻量级客户端，只保存用户自己的未消费输出。


交易的输出是以脚本(Script)的形式创建的，这个脚本设置了对兑换金额的“产权限制”，只能引入这个脚本的一个解后才能解除预置实现提款。简单点说就是，Alice的交易输出会包含一个脚本，这个脚本说 “谁能出示一个对应Bob地址对应密钥的签名，这个输出就支付给谁”。因为只有Bob的钱包的私钥可以匹配这个地址，所以只有Bob的钱包可以提供这个签名以兑换这笔输出。因此Alice会需要Bob的签名来限制输出的使用。


### Change

这个交易还会包含第二个输出。因为Alice的未花费交易输出金额是0.10比特币，对0.015 比特币一杯的咖啡来说太多了，需要找零给Alice 0.085比特币。Alice钱包创建给她的找零与付给Bob的支付在同一个交易里面。**可以说，Alice的钱包将她的金额分成了两个支付：一个给Bob，一个给自己。她可以在以后的交易里继续消费这笔找零输出。**

最后，为了让这笔交易尽快地被网络处理，**Alice的钱包会多付一小笔费用**。这个不是明显地包含在交易中的；而是通过输入和输出的差值所隐含的。如果Alice创建找零时只找 0.0845比特币，而不是 0.085比特币的话，就会有 0.0005比特币（50万聪） 。两笔输出加起来小于 0.10，所以这个 0.10 比特币的输入就没有被完整的消费了。这个差值会就被矿工收取当作交易费，作为矿工将交易放到区块里，最终打包到区块链帐薄中的费用。

任何比特币网络节点（其它客户端）收到一个之前没见过的有效交易时会立刻将它转发给它连接的其它节点。 因此，这个交易迅速地从P2P网络中传播开来，几秒内就能到达大多数节点。

### Mining

新交易不断地从用户钱包和其他应用流入比特币网络。当比特币网络上的节点看到这些交易时，会先将它们放到节点自行维护的一个**临时的未经验证的交易池**中。当矿工构建一个新区块时， 会将这些交易从这个交易池中拿出来放到一个新区块中，然后通过尝试解决一个难题（也叫工作量证明）以证明这个新区块的有效性

这些交易被加进新区块时，以交易费用和其它的一些规则进行排序。矿工一旦从网络上收到一个新区块， 就知道自己在这个区块上的解题竞赛已经输掉了，然后马上开始下一个新区块的挖矿。它会立刻将一些交易和最新那个区块的数字指纹放在一起开始构建下一个新区块，并开始工作量证明计算。**每个矿工会在他的区块中包含一个特殊的交易，将新生成的比特币（当前每区块为6.25比特币）作为矿工费支付到他自己的比特币地址，再加上块中所有交易的交易费用的总和作为自己的报酬。**如果他找到了使得新区块有效的解法，他就会得到这笔报酬，因为这个新区块被加入到了区块链总账中，他添加的这笔报酬交易也会变成可消费的。 参与矿池挖矿的Jing设置了他的软件，构建新区块时会将报酬地址设为整个矿池的地址。然后根据各自上一轮贡献的工作量将所得的报酬分给Jing和其他参与矿池挖矿的矿工。

Alice的交易被网络拿到后放进未验证交易池中。一旦被挖矿软件验证，它就被包含在由Jing的矿池生成的新区块（称为候选块）中。参与该矿池的所有矿工立即开始计算候选块的工作证明。大约在Alice的钱包将这个交易发送出来五分钟后，Jing的ASIC矿机发现了新区块的正解并将这个新区块发布到网络上，一旦结果被其它矿机验证成功，它们就会立即开始下一个新区块的竞赛。

Jing的ASIC矿机发现了新区块的正解并将之发布为第277,316号区块，包含420个交易，包括Alice的交易。将Alice交易包含在区块中就算做对该交易的一次"确认"。

既然Alice的这笔交易已经成为区块的一部分被嵌入到了区块链中，它就成为了整个分布式比特币账簿的一部分，并对所有比特币客户端应用可见。每个比特币客户端都能独立地验证这笔交易是有效且可消费的。全节点客户端可以追溯钱款的来源，从第一次有比特币在区块里生成的那一刻开始，按交易与交易间的关系顺藤摸瓜。

----
## Chapter 3

见 analysis.md

----

